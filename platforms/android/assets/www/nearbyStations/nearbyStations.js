// Generated by CoffeeScript 1.7.1
(function() {
  var failedCoords, gotCoords, populateNearbyStationsMap;

  $(document).on('pagebeforeshow', '#nearby_stations_page', function() {
    $('#nearby_stations_page').on('scrollstart', function(e) {
      return e.preventDefault();
    });
    return navigator.geolocation.getCurrentPosition(gotCoords, failedCoords, {
      timeout: 50000
    });
  });

  gotCoords = function(position) {
    return $.ajax({
      url: 'http://aqueous-reaches-7754.herokuapp.com/nearby_stations.json',
      type: 'get',
      dataType: 'json',
      data: {
        coords: [position.coords.latitude, position.coords.longitude]
      },
      timeout: 10000,
      success: function(json) {
        console.log('nearbyStations ajax success' + JSON.stringify(json));
        return populateNearbyStationsMap(json, position);
      },
      error: function(error) {
        return console.log('nearbyStations ajax failure' + JSON.stringify(error));
      }
    });
  };

  failedCoords = function(error) {
    console.log('geolocation error ' + error);
    navigator.notification.confirm('Faied to get location', null, 'Bad location', ['Continue']);
    return history.back();
  };

  populateNearbyStationsMap = function(stations, position) {
    var infoWindow, latlng, map, marker;
    latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
    map = new google.maps.Map(document.getElementById('nearbyStationsMap'), {
      center: latlng,
      zoom: 12,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    });
    marker = new google.maps.Marker({
      position: latlng,
      map: map
    });
    infoWindow = new google.maps.InfoWindow({
      content: '<div id="window"><p>You are here!</p></div>'
    });
    infoWindow.open(map, marker);
    return $(stations).each(function() {
      latlng = new google.maps.LatLng(this.lat, this.lon);
      marker = new google.maps.Marker({
        position: latlng,
        icon: '../img/train.png',
        message: "<p id=\"nearbyMessage\" onclick=\"displayStation('" + this.code + "')\">" + this.stationName + "</p> "
      });
      marker.setMap(map);
      return google.maps.event.addListener(marker, 'click', function() {
        infoWindow.setContent(this.message);
        return infoWindow.open(map, this);
      });
    });
  };

}).call(this);
